<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Setup - Bracket Engineering Docs</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../Cookly-CLI-Tool/cookly-cli.html"><strong aria-hidden="true">1.</strong> CLI Tool</a></li><li class="chapter-item expanded "><a href="../../frontend/frontend_prefix.html"><strong aria-hidden="true">2.</strong> Frontend</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../frontend/api/cognito.html"><strong aria-hidden="true">2.1.</strong> Cognito Via Amplify</a></li><li class="chapter-item expanded "><a href="../../frontend/api/api_caller.html"><strong aria-hidden="true">2.2.</strong> API Caller</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../frontend/api/generic_call.html"><strong aria-hidden="true">2.2.1.</strong> #genericCall()</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../backend/backend_prefix.html"><strong aria-hidden="true">3.</strong> Backend</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../backend/appRunner/apprunner.html"><strong aria-hidden="true">3.1.</strong> AppRunner</a></li><li class="chapter-item expanded "><a href="../../backend/cicd/cicd.html"><strong aria-hidden="true">3.2.</strong> CI/CD</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../backend/cicd/setup.html" class="active"><strong aria-hidden="true">3.2.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../../backend/cicd/example_template.html"><strong aria-hidden="true">3.2.2.</strong> Example Template</a></li></ol></li><li class="chapter-item expanded "><a href="../../backend/neptune/neptune.html"><strong aria-hidden="true">3.3.</strong> Neptune</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../backend/neptune/design_proposal.html"><strong aria-hidden="true">3.3.1.</strong> Design Proposal</a></li><li class="chapter-item expanded "><a href="../../backend/neptune/neptune_design.html"><strong aria-hidden="true">3.3.2.</strong> Database Schema</a></li><li class="chapter-item expanded "><a href="../../backend/neptune/neptune_api_design.html"><strong aria-hidden="true">3.3.3.</strong> API Design</a></li><li class="chapter-item expanded "><a href="../../backend/neptune/neptune_client.html"><strong aria-hidden="true">3.3.4.</strong> Neptune Client</a></li><li class="chapter-item expanded "><a href="../../backend/neptune/neptune_macros.html"><strong aria-hidden="true">3.3.5.</strong> Macro Data</a></li></ol></li><li class="chapter-item expanded "><a href="../../backend/data_analytics/data_analytics.html"><strong aria-hidden="true">3.4.</strong> Data Analytics</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Bracket Engineering Docs</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>This is an overview of how we will be using cloudformation templates using SAM (Serverless Application Model). Below there are some guides on how to format a template, the components of a template and how to modify it to a specific functionality.</p>
<hr />
<h3 id="cloudformation"><a class="header" href="#cloudformation">CloudFormation</a></h3>
<p>CloudFormation is an Infrastructure as Code (IaC) service provided by AWS that deploys infrastructure to the cloud for you usually via YAML templates.</p>
<h3 id="sam-serverless-application-model"><a class="header" href="#sam-serverless-application-model">SAM (Serverless Application Model)</a></h3>
<p>AWS SAM is an open-source framework developed by AWS for building serverless applications. It extends AWS CloudFormation to offer a simplified way of defining the Amazon API Gateway APIs, AWS Lambda functions, and Amazon DynamoDB tables needed by a serverless application.</p>
<hr />
<h1 id="how-we-are-using-cloudformation-and-sam"><a class="header" href="#how-we-are-using-cloudformation-and-sam">How we are using CloudFormation and SAM</a></h1>
<h2 id="directories"><a class="header" href="#directories">Directories</a></h2>
<p>We are using YAML files to define our resources to be passed to CloudFormation to be deployed.</p>
<p>The file structure of Lambda functions must be as follows:</p>
<pre><code>lambdas
└───── {lambda_name}
        └───── src/
                └───── {functionCodeFile}
        └───── template.yml
</code></pre>
<ul>
<li>Where {lambda_name} is the name of the lambda function</li>
<li>{functionCodeFile} is the actual code for the lambda function. The table below details the names that these files should take depending on the language:</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>Language</th><th>File Name</th></tr></thead><tbody>
<tr><td>JavaScript</td><td><code>index.mjs</code></td></tr>
<tr><td>Python</td><td><code>lambda_function.py</code></td></tr>
</tbody></table>
</div>
<p>Example:
<img src="./directory_example.png" alt="example" /></p>
<hr />
<h2 id="templateyml-files"><a class="header" href="#templateyml-files">Template.yml Files</a></h2>
<h4 id="transformations"><a class="header" href="#transformations">Transformations:</a></h4>
<p>CloudFormation templates that use SAM must be transformed from SAM syntax to plain CloudFormation syntax. To do this you need to include some instructions at the top of the template to instruct CloudFormation on how to convert the template.</p>
<pre><code class="language-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Transform: AWS::Serverless-2016-10-31
Description: SAM Template for {lambdaFunction_name}
</code></pre>
<h4 id="parameters"><a class="header" href="#parameters">Parameters:</a></h4>
<p>CloudFormation templates can be passed parameters that can be used in the template. In all of the templates, the Code Pipeline we use to build these templates passes the current GitHub commit hash to the template so that the template can get the correct version of the code from S3.</p>
<pre><code class="language-yaml">Parameters:
  CommitHash:
    Description: The commit hash for the Lambda deployment package
    Type: String
  Branch:
    Description: The branch for the Lambda deployment package
    Type: String
  APINAME:
    Description: The name of the API Gateway
    Type: String
    Default: &quot;API_NAME&quot; # Change this to name of API
  APIARN:
    Description: The ARN of the API Gateway
    Type: String
    Default: &quot;arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${APINAME}&quot;
  APIENDPOINT:
    Description: The endpoint of the API Gateway
    Type: String
    Default: &quot;API_ENDPOINT_NAME&quot; # name of endpoint path
    # should be same as lambda function in form `get-explore-page`
  FunctionName:
    Description: The name of the Lambda function
    Type: String
    Default: &quot;FUNCTION_NAME&quot; # replace this with actual function name
  Feature:
    Description: The feature name
    Type: String
    Default: &quot;FEATURE_NAME&quot; # replace this with the name of the feature that this lambda function is under (name of parent folder)
</code></pre>
<h3 id="resources"><a class="header" href="#resources">Resources:</a></h3>
<p>The resources part of the template is where you define the lambda functions, the versions, the alias's and the APIs.</p>
<h5 id="lambda-function"><a class="header" href="#lambda-function">Lambda Function:</a></h5>
<pre><code class="language-yaml">function:
  Type: AWS::Serverless::Function
  Properties:
    FunctionName: !Ref FunctionName
    Description: An AWS Lambda function that ...
    CodeUri: # where code for lambda function is stored
      Bucket: &quot;cookly-deployment-builds&quot;
      Key: !Sub &quot;${Branch}/${Feature}/${FunctionName}/${CommitHash}.zip&quot;
    Role: arn:aws:iam::${AWS::AccountId}:role/cookly-lambda-neptune-get # role for lambda function to assume
    Handler: index.handler # handler for lambda function - (for python use `lambda_function.lambda_handler`)
    Runtime: nodejs18.x # runtime - for Python use `python3.11`
    Timeout: 5 # time out in seconds
    MemorySize: 128 # RAM in MB (must be &gt;= 128MB)
    Architectures:
      - &quot;arm64&quot; # always use arm
    Layers: # list of layers for lambda function to use
      - arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:neptune-client:49
</code></pre>
<ul>
<li><code>file_name.function_name</code>: the file name of the lambda function and the name of the handler function.
<ul>
<li>For Python: <code>lambda_function.function_handler</code></li>
<li>For JavaScript: <code>index.handler</code></li>
</ul>
</li>
</ul>
<h5 id="lambda-function-aliass-and-versions"><a class="header" href="#lambda-function-aliass-and-versions">Lambda Function Alias's and Versions</a></h5>
<pre><code class="language-yaml"># Lambda function version
version:
  Type: AWS::Lambda::Version
  DependsOn: function
  Properties:
    FunctionName: !Ref function
    Description: !Sub &quot;Version for ${CommitHash}.&quot; # leave as this

# Lambda function alias
alias:
  Type: AWS::Lambda::Alias
  DeletionPolicy: Retain
  Properties:
    FunctionName: !Ref function
    FunctionVersion: !GetAtt version.Version
    Name: &quot;Production&quot; # leave as production for all lambda functions

    # config for provisioned concurrency.
    # Remove this whole bit if there is no Provisioned concurrency for this lambda function.
    ProvisionedConcurrencyConfig:
      ProvisionedConcurrentExecutions: 3
    # REMEMBER TO DELETE THIS IF NO CONCURRENCY NEEDED
</code></pre>
<h5 id="api"><a class="header" href="#api">API</a></h5>
<pre><code class="language-yaml"># API Gateway setup ASSUMING API IS ALREADY CREATED
apiResouce:
  Type: AWS::ApiGateway::Resource
  Properties:
    ParentId: !GetAtt MyApi.RootResourceId
    PathPart: &quot;ENDPOINT_NAME&quot; # the endpoint in your API of the lambda function
    RestApiId: !Ref APIARN

apiMethod:
  Type: AWS::ApiGateway::Method
  Properties:
    HttpMethod: POST # Request type of method (GET/POST/PUT etc)
    ResourceId: !Ref apiResouce
    RestApiId: !Ref APIARN
    AuthorizationType: AWS_IAM
    Integration:
      IntegrationHttpMethod: POST # Almost always leave as post
      Type: AWS_PROXY
      Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${function.Arn}:Production/invocations
    MethodResponses:
      - StatusCode: &quot;200&quot;
      - StatusCode: &quot;400&quot;
      - StatusCode: &quot;500&quot;

LambdaInvokePermission:
  Type: AWS::Lambda::Permission
  Properties:
    Action: lambda:InvokeFunction
    FunctionName: !Ref function
    Principal: apigateway.amazonaws.com
    SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${APINAME}/*/POST/ENDPOINT_NAME
</code></pre>
<ul>
<li>Shouldnt have to change most of the API gateway template for most lambda function integrations.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../backend/cicd/cicd.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../backend/cicd/example_template.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../backend/cicd/cicd.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../backend/cicd/example_template.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
