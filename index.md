# Cookly

*The code repository for the Cookly app*

Table of contents:
- [Cookly](#cookly)
- [Neptune](#neptune)
  - [Neptune Data Structure](#neptune-data-structure)
    - [Meal Nodes](#meal-nodes)
    - [User Nodes](#user-nodes)
  - [Neptune Scripts](#neptune-scripts)
    - [Neptune API Functions](#neptune-api-functions)
- [Dynamo or Document](#dynamo-or-document)
    - [LikedMeals Table](#likedmeals-table)
    - [Ingredients Table](#ingredients-table)
    - [Categories Table](#categories-table)
    - [Allergens Table](#allergens-table)
- [S3](#s3)
  - [S3 API Codes and Responses](#s3-api-codes-and-responses)
  - [S3 Data Structures and Other Information](#s3-data-structures-and-other-information)
    - [S3 Overview](#s3-overview)
    - [Our S3 Storage Structure](#our-s3-storage-structure)
    - [Meal JSON Format](#meal-json-format)
- [Lambda](#lambda)
    - [What is Lambda?](#what-is-lambda)
    - [Our Lambda Function Structure](#our-lambda-function-structure)
    - [Feature Branches](#feature-branches)
- [Database Codes](#database-codes)
  - [Ingredient Codes](#ingredient-codes)
  - [Category Codes](#category-codes)
  - [Allergen Codes](#allergen-codes)
- [API Endpoints](#api-endpoints)
- [Error Codes](#error-codes)
- [Docker Information](#docker-information)
  - [How to use Docker](#how-to-use-docker)
  - [Configuring Docker To Listen To UNIX Socket](#configuring-docker-to-listen-to-unix-socket)



# Neptune

## Neptune Data Structure

### Meal Nodes
When providing data to create a new meal, it **must** be in the following format:

```javascript
data = {
  // Below values generated by Gremlin:
  id: INT, // Unique ID added by Gremlin
  label: 'meal', // Added by Gremlin
  // Below values specified by us:
  name: "Meal #1",
  allergens: [INT, ...], // List of allergens (represented by codes)
  categories: [INT, ...], // List of category codes
  ingredients: [INT, ...] // List of ingredient codes.
}

// All numerical codes will be the same as the ID of that entity in DynamoDB.
```

### User Nodes

When providing data to create a new user node, it **must** be in the following format:

```javascript
data = {
  // Below values generated by Gremlin:
  id: INT, // Unique ID added by Gremlin
  label: 'user', // Added by Gremlin
  // Below values specified by us:
  allergens: [INT, ...], // List of user's allergens.
  preferences: [INT, ...], // List of categories that a user likes. (E.g vegan, mexican)
  dislikedIngredients: [INT, ...], // List of ingredients that user dislikes.
  dislikedCategories: [INT, ...] // List of category codes that a user dislikes.
}
```

## Neptune Scripts

All scripts for interacting with Neptune will throw JavaScript errors in the case of issues.
All errors must be caught and handled in the [API Endpoints](#api-endpoints).

### Neptune API Functions
| Function Name    | Parameters                                       | Notes |
| ---------------- | ------------------------------------------------ | ----- |
| `addMeal`        | `data`: Outlined [here](#neptune-data-structure) |       |
| `removeMealByID` | `id`: Integer ID of meal                         |       |
| `getMealByID`    | `id`: Integer ID of meal                         |       |

# Dynamo or Document

### LikedMeals Table

| Column | Description                      | Type |
| ------ | -------------------------------- | ---- |
| userID |                                  | int  |
| mealID |                                  | int  |
| count  | No. of times user has liked meal | int  |

### Ingredients Table

| Column        | Description                                                 | Type  |
| ------------- | ----------------------------------------------------------- | ----- |
| ingredientID  |                                                             | int   |
| name          | String name                                                 | str   |
| substitutions | List of ingredient IDs that can be substituted for this one | [int] |

### Categories Table

| Column     | Description | Type |
| ---------- | ----------- | ---- |
| categoryID |             | int  |
| name       | String name | str  |

### Allergens Table

| Column      | Description                                        | Type  |
| ----------- | -------------------------------------------------- | ----- |
| allergenID  |                                                    | int   |
| name        | String name                                        | str   |
| ingredients | List of ingredient IDs which include this allergen | [int] |

# S3

## S3 API Codes and Responses
| Function Name  | Parameters                                                                                                              |
| -------------- | ----------------------------------------------------------------------------------------------------------------------- |
| `getObject`    | `Key`: The s3 path (name) of the item you want to get                                                                   |
| `uploadObject` | `Key`: The name (includeing folders you want to put it in) `Body`: The contents of the folder you are wanting to upload |

## S3 Data Structures and Other Information

### S3 Overview

**What is S3?**

Simply put, S3 (Simple Storage Service) is an object storage service in the cloud.

`IMPORTANT: NOT A DATABASE`

**Storage in S3**

Storage in S3 is not structured, and is considered a data lake where data is stored in a single file

`Note: files and paths are for UI ease of use only`

### Our S3 Storage Structure

| Bucket     | Folders                            | Keys                                                                                          |
| ---------- | ---------------------------------- | --------------------------------------------------------------------------------------------- |
| `Metadata` | `Session`, `Features`              | Session: `Session_${sessionID}_${UserId}`, Features: `Features_${sessionID}_${UserId}`        |
| `Content`  | `Images`, `Main_Content`, `Method` | Images: `Image_${MealId}`, Main_Content: `Main_Content_${MealId}`, Method: `Method_${MealId}` |

### Meal JSON Format
```json
{
  "mealName": STRING,
  "servings": INT,
  "prepTime": {
    "time": INT,
    "unit": STR // E.g "min", "hr"
  },
  "cookTime": {
    "time": INT,
    "unit": STR
  },
  "tags": [STRING], // E.g "Vegan", "Healthy". 
  "ingredientsText": { // Ingredients separated into their uses
    "Ingredients": [STRING], // E.g "150g baby spinach"
    "For the falafel": [...],
    "SECTION_NAME": [...]
    // Ingredients in "Ingredients" section are not duplicated in the subsequent subsections
  },
  "ingredients": [INT], // List of ingredient IDs
  "method": [STRING] // List of instructions
}
```

# Lambda

### What is Lambda?

AWS Lambda is a serverless, event-driven compute service that lets you run code for virtually any type of application or backend service without provisioning or managing servers. You only need to pay for what you use.

### Our Lambda Function Structure
```bash
├── Dynamo ───> Returned to user
│   └── S3
│       └──> Returned to user
├── Neptune ───> Returned to user
│   └── Dynamo
│       └── S3
│           └──> Returned to user
│   └── Calculations
│       └── Dynamo
│           └──> Returned to user
│       └── S3
│           └──> Returned to user
│   └── S3
│       └──> Returned to user
 
```


### Feature Branches
```bash
├── Quick Meals
│   └── Neptune
│   │   └── Calculations
│   │   │   └── Dynamo 
│   │   │   └── S3 
├── Explore
│   └── Neptune
│   │   └── Calculations
│   │   │   └── Dynamo 
│   │   │   └── S3
├── Meal Planner
│   └── Dynamo
│   │   └── S3
├── User Information
│   └── Dynamo
├── Liked Meals
│   └── Dynamo
│   │   └── S3
```


# Database Codes

## Ingredient Codes

Will be stored elsewhere as it will be a large list.

## Category Codes

As yet undecided.

## Allergen Codes

| Code | Allergen    |
| ---- | ----------- |
| 1    | Celery      |
| 2    | Gluten      |
| 3    | Crustaceans |
| 4    | Eggs        |
| 5    | Fish        |
| 6    | Lupin       |
| 7    | Dairy       |
| 8    | Mollluscs   |
| 9    | Mustard     |
| 10   | Nuts        |
| 11   | Peanuts     |
| 12   | Sesame      |
| 13   | Soya        |
| 14   | Sulphites   |

# API Endpoints
**Calling backend API from React Native**

```javascript
const API_URL = 'https://API_ID.execute-api.REGION.amazonaws.com/STAGE/container/';

async function callFunction(id, name, args) {
  try {
    const response = await fetch(`${API_URL}${id}/function/${name}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        args,
      }),
    });
    const data = await response.json();
    return data;
  } catch (error) {
    console.error(error);
  }
}

```
This function will send a `GET` request to the `/container/{id}` resource of the API, passing the id as a URL parameter. The `/function/${name}` specifies the name of the function that needs to be executed in the container. The response from the API will be parsed as JSON and returned by the function.

You will need to replace `API_ID`, `REGION`, and `STAGE` with the appropriate values for the API. 

(the `STAGE` is just the version of the API you want to send the request to)

# Error Codes

```javascript 
// Error Format
throw new Error(`functionName: errCode ${value}`);

// Example:
throw new Error(`getVertexByID: notFound ${vertexID}`);
```




Below is the standard for error codes across our whole codebase.

| Code       | Meaning                                          |
| ---------- | ------------------------------------------------ |
| `unknown`  | Data type is correct but value is not recognised |
| `notFound` | Value could not be found in database.            |

